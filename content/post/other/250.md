---
title: "UndoBarを使った削除処理を考える"
slug: 250
date: 2015-04-23
lastmod: 2015-04-23
tags: 
---

<div id="wppda_alert">この記事は最終更新から3ヶ月以上が経過しています。情報が古い可能性があります。</div><p><a href="https://github.com/soarcn/UndoBar">UndoBar &#8211; GitHub</a></p>
<p>削除処理を行って、それを取り消し可能なようにする実装を考えます。例えばGmailのアプリでメッセージをアーカイブしたときなどに表示されるあれです。</p>
<p>削除する際に「本当に消しますか？」みたいな確認ダイアログを表示するのはナンセンスっぽいです。</p>
<p>なぜならその確認ダイアログは、データが消えてアクセスできなくなるという責任をユーザーに転嫁してるだけだということです。そもそも削除したいだけなのにいちいち確認されるのもうっとおしいだけではないかという理由もあります。</p>
<p>それならば、もし消したくないデータを誤って削除してしまったとしても、それを復元できるようにするのがユーザー目線でいいだろって話です。</p>
<p>この辺りの話はSmashing Android UI レスポンシブUIとデザインパターンという本で知りました。</p>
<div data-role="amazonjs" data-asin="4844334514" data-locale="JP" data-tmpl="" data-img-size="" class="asin_4844334514_JP_ amazonjs_item"><div class="amazonjs_indicator"><span class="amazonjs_indicator_img"></span><a class="amazonjs_indicator_title" href="#">Smashing Android UI レスポンシブUIとデザインパターン</a><span class="amazonjs_indicator_footer"></span></div></div>
<p>では実際に取消可能な削除機能を実装するためにはどうすればいいかというと、UndoBarを利用するのが簡単そうな気がします。Crouton使おうかと思ったけども、いざ使おうと思ったらレイアウトを実装したりするのが~~面倒~~大変だったので、シンプルなUndoBarを使いました。ソースコードはCroutonの方が読みやすかったけど。</p>
<h2>UndoBarの表示</h2>
<p>今回私がやりたかったのは、データベースに保存してあるデータを消すという例です。データベースに保存されているデータをListViewで表示している。そのListViewのうちの1つのアイテムを選んで削除をするというパターン。</p>
<p>実装方法としては削除の操作を行った時（UndoBarを表示させる時点）でどうするかによって、2パターンに分岐するかと思います。</p>
<ol>
<li>この時点で実際にDB上のデータを消してしまう</li>
<li>この時点ではDBは触らず、見た目上のデータを消す</li>
</ol>
<p>どちらのパターンにせよ、この時点でListViewに表示されてるデータを消すのは共通です。データベースのデータを消すタイミングがここかどうかです。</p>
<p>1．のパターンは見た目と実装がそのままリンクしています。Listから消えたらデータベースからも消える、シンプルです。</p>
<p>このパターンの場合は操作の取消を選んだら、消したデータを復元する必要があります。そのためどうやってデータをロールバックするのかに頭を悩ませることになります。データベースの構造が複雑だと元に戻すのが大変かもしれません。</p>
<p>2．の場合はUndoといいつつ、実際には削除処理を猶予しているだけです。このパターンの場合、取消操作はデータベースからデータを削除するのを取り消す処理（ややこしい）になります。</p>
<p>こちらは復元処理を考える必要がありません。一方でUndoBarが消える前にアプリを終了したり、画面が回転したときどうすんのっていう新たな問題が生じます。</p>
<h2>UndoBarからのコールバック</h2>
<p>UndoBarController.AdvancedUndoListenerを使うことで3つのタイミングによるコールバックを受け取ることができます。</p>
<p>この3つのコールバックをうまいこと利用して削除機能を実装していくことになります。</p>
<h3>onUndo()</h3>
<p>取消ボタンを押した際に呼ばれます。Undo時の処理をここで行うと良いです。</p>
<p>パターン1のときならここで復元処理を行うことになります。</p>
<h3>onHide()</h3>
<p>取消ボタンが押されず、UndoBarが消える際に呼ばれます。UndoBarに設定した表示時間が経過した後でコールされるわけです。UndoBar表示中に画面回転した場合には呼ばれません。</p>
<p>ちなみに画面回転に対応するには、自分でハンドリングしてやらないといけないそうです。今回私はそこまで踏み込みませんでした。</p>
<h3>onClear()</h3>
<p>UndoBar.clear()を明示的にコールした際に呼ばれます。</p>
<p>単に画面回転させたら呼ばれるのかというとそうではありません。画面回転時にコールバックを受け取りたいなら、Activity#onDestroy()（もしくはonStop(),onPause()）でclear()してやる必要があります。</p>
<p>そのためにはUndoBarのインスタンスをフィールド変数として保持しておかなりといけません。サンプルのように、単にnew UndoBar()して表示させていると、表示したUndoBarを識別できないので、clear()することができません。</p>
<p>ただし単にUndoBarを消したいときとごっちゃになってややこしくなるので、画面回転時にclearするのはよくないかもしれません。回転時は自分でハンドリングして再表示してやるのが一番いいと思います。</p>
<h2>削除機能を実装する</h2>
<h3>1.実際に削除するパターン</h3>
<p>onUndo()で削除した対象のデータを元に戻します。このパターンだとここがややこしいです。</p>
<p>消すデータをメモリ上に確保しておいて、Undoされたら消したデータを再インサートする。データベースに削除フラグ持たせてそれを立てる。退避用テーブルにデータを移しておく。・・・どういう方法を取るのがベストなんでしょうかね？</p>
<p>ちなみに私はメモリ上にデータを持たせて、Undoされた際に再登録する方法を選びました。</p>
<p>onHide()は何もしないでいいです。UndoBar表示時点でデータは消えてますので。</p>
<p>onClear()はonHide()と同じ処理でいいでしょう。</p>
<h3>2.Undoされなかったら消すパターン</h3>
<p>onUndo()はListViewを元に戻すだけでいいです。データベースは変更されていないので、DBから読みなおすなり、消したデータだけAdapterに追加するでもいいと思います。</p>
<p>onHide()で実際にデータベースからデータを消します。</p>
<p>onClear()はonHide()と同様にデータベースからデータを消します。でないとUndoBar表示中に追加で削除処理が実行された際に困ります。</p>
<h2>UndoBar表示中に追加の削除処理を行ったとき</h2>
<p>UndoBar表示中に更に削除処理を行い新しいUndoBarを表示させたらどうなるか。表示されているUndoBarは以前のもののままです。新しいUndoBarは古いUndoBarの表示時間が過ぎた後で表示されます。</p>
<p>これでは削除対象と表示されてるUndoBarがリンクしないのでよろしくありません。今削除したものを取り消したつもりが、以前処理した奴が取り消されてしまったということになります。</p>
<p>そのため削除処理を行ったら、現在表示中のUndoBarはclear()で消すべきでしょう。</p>
<h2>簡単そうでいざ実装してみると大変だった</h2>
<p>UndoBarを使って取消可能な削除機能を実装してみましたが、やってみると考えることが多くて意外と大変でした。</p>
<p>それでも自力で実装しようと思うともっと大変でしょうから、ライブラリ作者様には頭が上がりません。</p>
<p>UndoBarはbuild.gradleに1行追加するだけで使えるようになるので、削除処理を実装するときには仕様を検討してみてください。</p>
<p><a href="https://github.com/soarcn/UndoBar">UndoBar &#8211; GitHub</a></p>

  